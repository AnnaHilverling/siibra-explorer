<ng-container *ngIf="meetsRequirement; else doesNotMeetReqTemplate">

  <ng-container *ngTemplateOutlet="viewerBody">
  </ng-container>
</ng-container>

<ng-template #helpComponent>
  <h2 mat-dialog-title>About Interactive Viewer</h2>
  <mat-dialog-content>
    <mat-tab-group>
      <mat-tab label="Help">
        <help-component>
        </help-component>
      </mat-tab>
      <mat-tab label="Privacy Policy">
        <!-- TODO make tab container scrollable -->
        <cookie-agreement>
        </cookie-agreement>
      </mat-tab>
      <mat-tab label="Terms of Use">
        <kgtos-component>
        </kgtos-component>
      </mat-tab>
    </mat-tab-group>
  </mat-dialog-content>

  <mat-dialog-actions class="justify-content-center">
    <button
      mat-flat-button
      (click)="closeModal('help')"
      cdkFocusInitial>
      close
    </button>
  </mat-dialog-actions>
</ng-template>

<!-- signin -->
<ng-template #signinModalComponent>
  <h2 mat-dialog-title>Sign in</h2>
  <mat-dialog-content>
    <signin-modal>
    </signin-modal>
  </mat-dialog-content>
</ng-template>

<!-- kg tos -->
<ng-template #kgToS>
  <h2 mat-dialog-title>Knowldge Graph ToS</h2>
  <mat-dialog-content class="w-50vw">
    <kgtos-component>
    </kgtos-component>
  </mat-dialog-content>

  <mat-dialog-actions class="justify-content-end">
    <button
      color="primary"
      mat-raised-button
      (click)="kgTosClickedOk()"
      cdkFocusInitial>
      Ok
    </button>
  </mat-dialog-actions>
</ng-template>

<!-- cookie -->
<ng-template #cookieAgreementComponent>
  <h2 mat-dialog-title>Cookie Disclaimer</h2>
  <mat-dialog-content class="w-50vw">
    <cookie-agreement>
    </cookie-agreement>
  </mat-dialog-content>

  <mat-dialog-actions class="justify-content-end">
    <button
      color="primary"
      mat-raised-button
      (click)="cookieClickedOk()"
      cdkFocusInitial>
      Ok
    </button>
  </mat-dialog-actions>
</ng-template>

<!-- atlas template -->
<ng-template #viewerBody>
  <div class="atlas-container" (drag-drop)="localFileService.handleFileDrop($event)" helpdirective>

    <ui-nehuba-container (contextmenu)="$event.stopPropagation(); $event.preventDefault();"> <!--nehubaClickHandler($event)-->
    </ui-nehuba-container>
  
    <div class="z-index-10 position-absolute pe-none w-100 h-100">

      <!-- dataset search side nav -->
      <mat-drawer-container
        *ngIf="newViewer$ | async"
        [hasBackdrop]="false"
        class="w-100 h-100 bg-none mat-drawer-content-overflow-visible">
        <mat-drawer
          mode="push"
          class="col-10 col-sm-10 col-md-4 col-lg-3 col-xl-2 p-2 bg-none box-shadow-none overflow-visible"
          [disableClose]="true"
          [autoFocus]="false"
          [opened]="true"
          #sideNavDrawer>
          <search-side-nav
            (dismiss)="sideNavDrawer.close()"
            (open)="sideNavDrawer.open()"
            class="h-100 d-block overflow-visible"
            #searchSideNav>
          </search-side-nav>

        </mat-drawer>

        <!-- tag for opening and closing side nav -->
        <div class="d-flex h-100 align-items-start bg-none pe-none">

          <button mat-flat-button
            matBadgePosition="above after"
            matBadgeColor="accent"
            [matBadge]="!sideNavDrawer.opened && (selectedRegions$ | async)?.length ? (selectedRegions$ | async)?.length : null"
            [matTooltip]="!sideNavDrawer.opened ? (selectedRegions$ | async)?.length ?  ('Explore ' + (selectedRegions$ | async)?.length + ' selected regions.') : 'Explore current view' : null"
            [ngClass]="{'translate-x-6-n': !sideNavDrawer.opened, 'translate-x-7-n': sideNavDrawer.opened}"
            class="pe-all mt-5"
            (click)="sideNavDrawer.toggle()">
            <i [ngClass]="{'fa-chevron-left': sideNavDrawer.opened, 'fa-chevron-right': !sideNavDrawer.opened}" class="fas translate-x-3"></i>

          </button>

          <mat-card *ngIf="!sideNavDrawer.opened"
            (click)="sideNavDrawer.open()"
            mat-ripple
            class="pe-all mt-4 muted translate-x-4-n">
            <mat-card-content>
              <viewer-state-mini>
              </viewer-state-mini>
            </mat-card-content>
            <mat-card-footer></mat-card-footer>
          </mat-card>

          <!-- TODO clean up menu icon -->
        </div>
      </mat-drawer-container>
    </div>

    <div class="d-flex flex-row justify-content-end z-index-10 position-absolute pe-none w-100 h-100">
      <signin-banner signinWrapper [ngStyle]="{'margin-right': !selectedTemplate? '20px': ''}">
      </signin-banner>
    </div>
  
    <layout-floating-container
      zIndex="13"
      #floatingOverlayContainer>
      <div floatingContainerDirective>
  
      </div>
      
      <!-- TODO deprecate -->
      <!-- TODO move to nehuba overlay container -->
      <panel-component class="shadow" fixedMouseContextualContainerDirective #rClContextMenu>
        <div heading>
          <h5 class="pe-all p-2 m-0">
            What's here?
          </h5>
        </div>
        <div body>

          <div
            *ngIf="(onhoverSegmentsForFixed$ | async)?.length > 0 || (selectedRegions$ | async)?.length > 0"
            class="p-2">
            Search for data relating to:
          </div>

          <div *ngIf="(onhoverLandmarksForFixed$ | async) as onhoverLandmarksForFixed">
            <div *ngIf="onhoverLandmarksForFixed && onhoverLandmarksForFixed.datasets && onhoverLandmarksForFixed.datasets.length > 0">
              <div class="p-2">
                Explore datasets for {{onhoverLandmarksForFixed.landmarkName}}
              </div>
              <div
                      *ngFor="let dataset of onhoverLandmarksForFixed.datasets"
                      class="ws-no-wrap text-left pe-all btn btn-sm btn-secondary btn-block mt-0"
                      data-toggle="tooltip"
                      data-placement="top"
                      (click)="openLandmarkUrl(dataset)"
                      [title]="dataset.name">
                {{ dataset.name }} <i class="fas fa-external-link-alt"></i>
              </div>
            </div>
          </div>
          
          <div
            *ngFor="let onhoverSegmentFixed of (onhoverSegmentsForFixed$ | async)"
            (click)="searchRegion([onhoverSegmentFixed])"
            class="ws-no-wrap text-left pe-all btn btn-sm btn-secondary btn-block mt-0"
            data-toggle="tooltip"
            data-placement="top"
            [title]="onhoverSegmentFixed.name">
            <small class="text-semi-transparent">(hovering)</small> {{ onhoverSegmentFixed.name }}
          </div>
  
          <div
            *ngIf="(selectedRegions$ | async)?.length > 0 && (selectedRegions$ | async); let selectedRegions"
            (click)="searchRegion(selectedRegions)"
            class="ws-no-wrap text-left pe-all mt-0 btn btn-sm btn-secondary btn-block">
            <ng-container *ngIf="selectedRegions.length > 1">
              <small class="text-semi-transparent">(selected)</small> {{ selectedRegions.length }} selected regions
            </ng-container>
            <ng-container *ngIf="selectedRegions.length === 1">
              <small class="text-semi-transparent">(selected)</small> {{ selectedRegions[0].name }}
            </ng-container>
          </div>

          <div
            class="p-2 text-muted"
            *ngIf="(onhoverSegmentsForFixed$ | async)?.length === 0 && (selectedRegions$ | async)?.length === 0 && (onhoverLandmarksForFixed$ | async)?.length === 0">
            Right click on a parcellation region or select parcellation regions to search KG for associated datasets.
          </div>
  
          <ng-template #noRegionSelected>
            <div
              (click)="searchRegion()"
              class="ws-no-wrap text-left pe-all mt-0 btn btn-sm btn-secondary btn-block">
              No region selected. Search KG for all datasets in this template space.
            </div>
          </ng-template>
  
        </div>
      </panel-component>
      
      <div floatingMouseContextualContainer floatingMouseContextualContainerDirective>
        <div
          *ngIf="onhoverLandmark$ | async"
          contextualBlock>
          {{ (onhoverLandmark$ | async)?.landmarkName }} <i><small class = "mute-text">{{ toggleMessage }}</small></i>
        </div>
        <div
          *ngIf="onhoverSegments$ | async; let onhoverSegments"
          contextualBlock>
          <div
            *ngFor="let segment of onhoverSegments"
            [innerHtml]="segment | transformOnhoverSegment">
          </div>
          <i><small class = "mute-text">{{ toggleMessage }}</small></i>
        </div>
        <!-- TODO Potentially implementing plugin contextual info -->
      </div>

    </layout-floating-container>
  
    <div pluginFactoryDirective>
    </div>
  </div>
</ng-template>

<!-- does not meet req template -->
<ng-template #doesNotMeetReqTemplate>
  <div class="d-flex flex-column" minReq *ngIf="!meetsRequirement">
    <div class="jumbotron bg-light text-center mb-0">
      <div>
        <h1 class="mb-3">
          <i class="fas fa-exclamation-triangle"></i> Unsupported browser detected
        </h1>
        <p>
          We recommend using the latest version of <a target="_blank" href="https://www.google.com/chrome/">Google Chrome</a>
          or <a target="_blank" href="https://www.mozilla.org/firefox/">Mozilla Firefox)</a> for viewing the interactive viewer.
        </p>
        <div class="col-6 d-inline-block text-left">
          <readmore-component
            [collapsedHeight]="0">
            <markdown-dom [markdown]="constantsService.minReqExplaner">
  
            </markdown-dom>
          </readmore-component>
        </div>
        
      </div>
    </div>
    <ng-container *ngFor="let preview of unsupportedPreviews; let idx = index">
      <div [hidden]="idx !== unsupportedPreviewIdx" class="text-center mb-3" imageContainer [style.backgroundImage]="'url(' + preview.previewSrc + ')'" >
        <div class="mt-2 card d-inline-block displayCard">
          <div class="card-body">
            {{ preview.text }}
          </div>
        </div>
      </div>
    </ng-container>
  </div>
</ng-template>
