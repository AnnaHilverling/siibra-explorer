<mat-card>

  <!-- template selection -->
  <mat-form-field>
    <mat-label>
      Template
    </mat-label>
    <mat-select
      [value]="(templateSelected$ | async)?.name"
      (selectionChange)="handleTemplateChange($event)"
      (openedChange)="focused = $event">
      <mat-option
        *ngFor="let template of (availableTemplates$ | async)"
        [value]="template.name">
        {{ template.name }}
      </mat-option>
    </mat-select>
  </mat-form-field>
  <ng-container *ngIf="templateSelected$ | async as templateSelected">
    <ng-container *ngIf="(templateSelected | templateParcellationsDecorationPipe)?.extraButtons as extraButtons">
      <button
        *ngFor="let extraBtn of extraButtons"
        (click)="handleActiveDisplayBtnClicked($event, 'template', extraBtn, templateSelected)"
        mat-icon-button>
        <i [class]="extraBtn.faIcon"></i>
      </button>
    </ng-container>
  </ng-container>

  <!-- parcellation selection -->
  <mat-form-field *ngIf="templateSelected$ | async as templateSelected">
    <mat-label>
      Parcellation
    </mat-label>
    <mat-select
      (selectionChange)="handleParcellationChange($event)"
      [value]="(parcellationSelected$ | async)?.name"
      (openedChange)="focused = $event">
      <mat-option
        *ngFor="let parcellation of (templateSelected.parcellations | appendTooltipTextPipe)"
        [value]="parcellation.name">
        {{ parcellation.name }}
      </mat-option>
    </mat-select>
  </mat-form-field>

  <ng-container *ngIf="parcellationSelected$ | async as parcellationSelected">
    <ng-container *ngIf="(parcellationSelected | templateParcellationsDecorationPipe)?.extraButtons as extraButtons">
      <button
        *ngFor="let extraBtn of extraButtons"
        (click)="handleActiveDisplayBtnClicked($event, 'parcellation', extraBtn, parcellationSelected)"
        mat-icon-button>
        <i [class]="extraBtn.faIcon"></i>
      </button>
    </ng-container>
  </ng-container>

  <!-- divider -->
  <mat-divider></mat-divider>

  <!-- selected regions -->

  <div class="d-flex">
    <region-text-search-autocomplete
      (focusedStateChanged)="focused = $event">
    </region-text-search-autocomplete>
  </div>

  <!-- chips -->
  <mat-card class="w-20em mh-10em overflow-auto overflow-x-hidden">
    <mat-chip-list class="mat-chip-list-stacked" #selectedRegionsChipList>
      <mat-chip class="w-100" *ngFor="let region of (regionsSelected$ | async)">
        <span class="flex-grow-1 flex-shrink-1 text-truncate">
          {{ region.name }}
        </span>
        <button
          *ngIf="region.position"
          (click)="gotoRegion($event, region)"
          mat-icon-button>
          <i class="fas fa-map-marked-alt"></i>
        </button>
        <button
          (click)="deselectRegion($event, region)"
          mat-icon-button>
          <i class="fas fa-trash"></i>
        </button>
      </mat-chip>
    </mat-chip-list>

    <!-- place holder when no regions has been selected -->
    <span class="muted"  *ngIf="(regionsSelected$ | async).length === 0">
      No regions selected. Double click on any regions in the viewer, or use the search tool to select regions of interest.
    </span>
  </mat-card>

  <!-- control btns -->
  <div class="mt-2 mb-2 d-flex justify-content-between">
    <div class="d-flex">

      <!-- save  -->
      <button
        matTooltip="Save this selection of regions"
        matTooltipPosition="below"
        mat-button
        (click)="saveSelection($event)"
        color="primary">
        <i class="fas fa-save"></i>
        
      </button>

      <!-- load -->
      <button
        (click)="loadSelection($event)"
        matTooltip="Load a selection of regions"
        matTooltipPosition="below"
        mat-button
        color="primary"
        [disabled]="(savedRegionsSelections$ | async)?.length === 0">
        <i
          matBadgeColor="accent"
          [matBadgeOverlap]="false"
          [matBadge]="(savedRegionsSelections$ | async)?.length > 0 ? (savedRegionsSelections$ | async)?.length : null"
          class="fas fa-folder-open"></i>
        
      </button>
    </div>

    <!-- deselect all  -->
    <button
      (click)="deselectAllRegions($event)"
      matTooltip="Deselect all selected regions"
      matTooltipPosition="below"
      mat-raised-button
      color="warn"
      [disabled]="(regionsSelected$ | async)?.length === 0">
      <i class="fas fa-trash"></i>
    </button>
  </div>
</mat-card>

<ng-template #publicationTemplate>
  <single-dataset-view
    *ngFor="let focusedDataset of (focusedDatasets$ | async)"
    [name]="focusedDataset.name"
    [description]="focusedDataset.description"
    [publications]="focusedDataset.publications"
    [kgSchema]="focusedDataset.kgSchema"
    [kgId]="focusedDataset.kgId">
    
  </single-dataset-view>
</ng-template>

<!-- bottom sheet for saved regions  -->
<ng-template #savedRegionBottomSheetTemplate>
  <mat-action-list>

    <!-- separated (binned) by template/parcellation -->
    <ng-container *ngFor="let binnedRS of (savedRegionsSelections$ | async | binSavedRegionsSelectionPipe); let index = index">

      <!-- only render divider if it is not the leading element -->
      <mat-divider *ngIf="index !== 0"></mat-divider>

      <!-- header -->
      <h3 mat-subheader>
        {{ binnedRS.templateSelected.name }} / {{ binnedRS.parcellationSelected.name }}
      </h3>

      <!-- ng for all saved regions -->
      <button
        *ngFor="let savedRegionsSelection of binnedRS.regionSelections"
        (click)="loadSavedRegion($event, savedRegionsSelection)"
        mat-list-item>
        <!-- [class]="savedRegionsSelection | savedRegionsSelectionBtnDisabledPipe : (templateSelected$ | async) : (parcellationSelected$ | async) ? 'text-muted' : ''" -->
        <!-- [disabled]="savedRegionsSelection | savedRegionsSelectionBtnDisabledPipe : (templateSelected$ | async) : (parcellationSelected$ | async)" -->
        <!-- main content -->
        <span class="flex-grow-0 flex-shrink-1">
          {{ savedRegionsSelection.name }}
        </span>
        <small class="ml-1 mr-1 text-muted flex-grow-1 flex-shrink-0">
          ({{ savedRegionsSelection.regionsSelected.length }} selected regions)
        </small>

        <!-- edit btn -->
        <button
          (mousedown)="$event.stopPropagation()"
          (click)="editSavedRegion($event, savedRegionsSelection)"
          mat-icon-button>
          <i class="fas fa-edit"></i>
        </button>

        <!-- trash btn -->
        <button
          (mousedown)="$event.stopPropagation()"
          (click)="removeSavedRegion($event, savedRegionsSelection)"
          mat-icon-button
          color="warn">
          <i class="fas fa-trash"></i>
        </button>
      </button>
    </ng-container>
  </mat-action-list>
</ng-template>