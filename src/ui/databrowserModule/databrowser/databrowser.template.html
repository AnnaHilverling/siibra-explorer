<mat-card
  [ngClass]="{'h-100': (!fetchingFlag && !fetchError)}"
  class="w-100 overflow-hidden d-block flex-grow-1 flex-shrink-1 d-flex flex-column">

  <!-- transclusion header -->
  <ng-content select="[card-header]">
  </ng-content>
  
  <!-- transclusion content prepend -->
  <ng-content select="[card-content='prepend']">
  </ng-content>

  <!-- modality filter -->
  <div class="mb-1" >
    <ng-container *ngTemplateOutlet="modalitySelector">
    </ng-container>
  </div>

  <!-- if still loading, show spinner -->
  <ng-template [ngIf]="fetchingFlag">
    <ng-container *ngTemplateOutlet="loadingSpinner">
    </ng-container>
  </ng-template>

  <!-- else, show fetched -->
  <ng-template [ngIf]="!fetchingFlag">

    <!-- if error, show error only -->
    <ng-template [ngIf]="fetchError">
      <ng-container *ngTemplateOutlet="errorTemplate">
      </ng-container>
    </ng-template>

    <!-- if not error, show dataset template -->
    
    <ng-template [ngIf]="!fetchError">
      <ng-container *ngTemplateOutlet="datasetTemplate">
      </ng-container>
    </ng-template>
  </ng-template>

  <!-- footer, populated by content transclusion -->
  <mat-card-footer>
    <ng-content select="[card-footer]">
    </ng-content>
  </mat-card-footer>
</mat-card>

<ng-template #loadingSpinner>
  <mat-card-content>
    <div class="m-2 d-flex flex-row align-items-center justify-content star">
      <div class="d-inline-block mr-2 spinnerAnimationCircle"></div>
      <span>Fetching datasets...</span>
    </div>
  </mat-card-content>
</ng-template>

<ng-template #errorTemplate>
  <mat-card-content>
    <div class="ml-2 mr-2 alert alert-danger">
      <i class="fas fa-exclamation-triangle"></i> Error fetching data. <a href="#" (click)="retryFetchData($event)" class="btn btn-link text-info">retry</a>    
    </div>
  </mat-card-content>
</ng-template>

<ng-template #datasetTemplate>
  <!-- datawrapper -->

  <ng-container *ngIf="dataentries | filterDataEntriesByMethods : visibleCountedDataM as filteredDataEntry">
    <mat-card-content class="h-100 w-100 overflow-hidden">
      <cdk-virtual-scroll-viewport
        class="h-100"
        autosize>
        <div class="virtual-scroll-element"
          *cdkVirtualFor="let dataset of filteredDataEntry; trackBy: trackByFn; templateCacheSize: 0; let index = index">

          <!-- divider, show if not first -->
          <mat-divider *ngIf="index !== 0"></mat-divider>

          <single-dataset-list-view
            class="d-block pt-1 pb-1"
            [kgSchema]="(dataset.fullId | getKgSchemaIdFromFullIdPipe)[0]"
            [kgId]="(dataset.fullId | getKgSchemaIdFromFullIdPipe)[1]"
            [dataset]="dataset"
            [ripple]="true">
    
          </single-dataset-list-view>
          

        </div>
      </cdk-virtual-scroll-viewport>
    </mat-card-content>
  </ng-container>
</ng-template>

<ng-template #filePreviewTemplate>
  <preview-component
    *ngIf="filePreviewName"
    [datasetName]="filePreviewName">

  </preview-component>
</ng-template>

<!-- modality picker / filter -->
<ng-template #modalitySelector>
  <mat-accordion class="flex-grow-0 flex-shrink-0">

    <!-- Filters -->
    <mat-expansion-panel hideToggle>

      <mat-expansion-panel-header class="align-items-center">
        <mat-panel-title class="d-inline-flex align-items-center">
          Filter
        </mat-panel-title>

        <mat-panel-description class="d-flex flex-row justify-content-end align-items-center">

          <small *ngIf="dataentries.length > 0" class="text-muted mr-2">
            <ng-template [ngIf]="modalityPickerCmp && modalityPickerCmp.checkedModality.length > 0"
              [ngIfElse]="noFilterTmpl">
              {{ (dataentries | filterDataEntriesByMethods : visibleCountedDataM).length }} / {{ dataentries.length }}
            </ng-template>
            
            <ng-template #noFilterTmpl>
              {{ dataentries.length }} datasets
            </ng-template>
          </small>

          <button mat-icon-button
            matTooltip="Clear filters"
            iav-stop="mousedown click"
            iav-delay-event="click"
            (delayedEmit)="modalityPickerCmp && modalityPickerCmp.clearAll()"
            *ngIf="modalityPickerCmp.checkedModality.length > 0"
            color="primary">
            <i class="fas fa-backspace"></i>
          </button>
        </mat-panel-description>

      </mat-expansion-panel-header>

      <div class="max-h-10em overflow-y-auto overflow-x-hidden">
        <modality-picker
          iav-stop="click"
          class="w-100"
          [countedDataM]="countedDataM"
          (modalityFilterEmitter)="handleModalityFilterEvent($event)"
          #modalityPickerCmp>
      
        </modality-picker>
      </div>

    </mat-expansion-panel>
  </mat-accordion>

</ng-template>

<!-- currently unused -->
<ng-template #history>
  <mat-list>
    <mat-list-item *ngFor="let item of (history$ | async)">
      Viewed {{ item.file.name }}
    </mat-list-item>
  </mat-list>
</ng-template>