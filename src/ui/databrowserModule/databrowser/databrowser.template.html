<mat-tab-group [dynamicHeight]="false" class="h-100 w-100 overflow-hidden">
  <mat-tab label="Search Criteria">
    <ng-container *ngTemplateOutlet="searchPanel">

    </ng-container>
  </mat-tab>
  <mat-tab label="History">
    <ng-container *ngTemplateOutlet="history">

    </ng-container>
  </mat-tab>
</mat-tab-group>

<ng-template #searchPanel>

  <div class="h-100 w-100 d-flex flex-column overflow-hidden">
    
    <!-- search criterial -->
    <mat-selection-list class="flex-grow-0 flex-shrink-0 mb-2" checkboxPosition="before">
      <h3 mat-subheader>
        Search criteria
      </h3>

      <!-- selected regions -->
      <mat-list-option
        selected="true"
        checkboxPosition="before">
        <h4 mat-line>
          {{ regions.length }} selected region{{ regions.length !== 1 ? 's' : ''}}

          <!-- stop mousedown propagation to avoid ripple from mat-list-option -->
          <region-text-search-autocomplete (mousedown)="$event.stopPropagation()" (click)="$event.stopPropagation()" [showAutoComplete]="false">
          </region-text-search-autocomplete>
        </h4>
      </mat-list-option>

      <mat-list-option
        *ngIf="dbService.viewportBoundingBox$ | async as bbox"
        checkboxPosition="before"
        [selected]="true">
        <h4 class="mat-line">
          viewport bounding box 
        </h4>

        <!-- from -->
        <p class="mat-line">
          <small>
            <span *ngFor="let v of bbox[0]; let lastval = last">
              {{ v | number : '1.2-2' }}<span *ngIf="!lastval">, </span>
            </span>
            <span>
              to
            </span>
            <span *ngFor="let v of bbox[1]; let lastval = last">
              {{ v | number : '1.2-2' }}<span *ngIf="!lastval">, </span>
            </span>
          </small>
        </p>
        
      </mat-list-option>
    </mat-selection-list>

    <mat-divider class="position-relative"></mat-divider>

    <!-- modality picker / filter -->
    <mat-accordion class="flex-grow-0 flex-shrink-0 mb-2">
      <mat-expansion-panel>
        <mat-expansion-panel-header>
          <mat-panel-title>
            Filter
          </mat-panel-title>
          <mat-panel-description>
            <i *ngIf="dataentries.length > 0">
              <span *ngIf="visibleCountedDataM && visibleCountedDataM.length > 0 "> 
                {{ (dataentries | filterDataEntriesByMethods : visibleCountedDataM).length }} filtered /
              </span>
              {{ dataentries.length }} results
            </i>
            <i *ngIf="dataentries.length === 0">
              No results to show.
            </i>
          </mat-panel-description>
        </mat-expansion-panel-header>

        <ng-container *ngTemplateOutlet="modalityPicker">

        </ng-container>
      </mat-expansion-panel>
    </mat-accordion>

    <!-- datasets container -->
    <div *ngIf="fetchingFlag; else fetched"
      class="spinnerAnimationCircleContainer">
      <div class="spinnerAnimationCircle"></div>
      <div>Fetching datasets...</div>
    </div>

  </div>

</ng-template>

<ng-template #modalityPicker>
  <modality-picker
    (click)="$event.stopPropagation();"
    class="w-100"
    [countedDataM]="countedDataM"
    (modalityFilterEmitter)="handleModalityFilterEvent($event)">

  </modality-picker>
</ng-template>

<ng-template #fetched>
  <div class="ml-2 mr-2 alert alert-danger" *ngIf="fetchError; else showData">
    <i class="fas fa-exclamation-triangle"></i> Error fetching data. <a href="#" (click)="retryFetchData($event)" class="btn btn-link text-info">retry</a>
  </div>
</ng-template>

<ng-template #showData>
  <!-- datawrapper -->
  <ng-container *ngIf="dataentries | filterDataEntriesByMethods : visibleCountedDataM as filteredDataEntry">

    <!-- dataentries -->
    <div class="h-100 w-100">
      <cdk-virtual-scroll-viewport 
        class="h-100"
        itemSize="50">
        <single-dataset-view
          *cdkVirtualFor="let dataset of filteredDataEntry"
          (click)="showFocusedDataset(dataset)"
          class="m-2"
          [kgSchema]="(dataset.fullId | getKgSchemaIdFromFullIdPipe)[0]"
          [kgId]="(dataset.fullId | getKgSchemaIdFromFullIdPipe)[1]"
          [prefetched]="dataset"
          [simpleMode]="true"
          [ripple]="true">

        </single-dataset-view>
    </cdk-virtual-scroll-viewport>
  </div>

  </ng-container>
</ng-template>

<ng-template #filePreviewTemplate>
  <preview-component
    *ngIf="filePreviewName"
    [datasetName]="filePreviewName">

  </preview-component>
</ng-template>

<ng-template #detailDataset>

  <single-dataset-view
    [prefetched]="focusedDataset">

  </single-dataset-view>
</ng-template>
  
<ng-template #history>
  <mat-list>
    <mat-list-item *ngFor="let item of (history$ | async)">
      Viewed {{ item.file.name }}
    </mat-list-item>
  </mat-list>
</ng-template>