<mat-card
  [ngClass]="{'h-100': (!fetchingFlag && !fetchError)}"
  class="w-100 overflow-hidden d-block flex-grow-1 flex-shrink-1 d-flex flex-column">

  <!-- transclusion header -->
  <mat-card-header>
    <ng-content select="[card-header]">

    </ng-content>
  </mat-card-header>
  
  <!-- transclusion header -->
  <ng-content select="[card-content='prepend']">
  </ng-content>

  <!-- modality filter -->
  <ng-container *ngTemplateOutlet="modalitySelector">
  </ng-container>

  <!-- if still loading, show spinner -->
  <ng-template [ngIf]="fetchingFlag">
    <ng-container *ngTemplateOutlet="loadingSpinner">
    </ng-container>
  </ng-template>

  <!-- else, show fetched -->
  <ng-template [ngIf]="!fetchingFlag">

    <!-- if error, show error only -->
    <ng-template [ngIf]="fetchError">
      <ng-container *ngTemplateOutlet="errorTemplate">
      </ng-container>
    </ng-template>

    <!-- if not error, show dataset template -->
    
    <ng-template [ngIf]="!fetchError">
      <ng-container *ngTemplateOutlet="datasetTemplate">
      </ng-container>
    </ng-template>
  </ng-template>

  <!-- footer, populated by content transclusion -->
  <mat-card-footer>
    <ng-content select="[card-footer]">
    </ng-content>
  </mat-card-footer>
</mat-card>

<ng-template #loadingSpinner>
  <mat-card-content>
    <div class="m-2 d-flex flex-row align-items-center justify-content star">
      <div class="d-inline-block mr-2 spinnerAnimationCircle"></div>
      <span>Fetching datasets...</span>
    </div>
  </mat-card-content>
</ng-template>

<ng-template #modalityPicker>
  <modality-picker
    (click)="$event.stopPropagation();"
    class="w-100"
    [countedDataM]="countedDataM"
    (modalityFilterEmitter)="handleModalityFilterEvent($event)">

  </modality-picker>
</ng-template>

<ng-template #errorTemplate>
  <mat-card-content>
    <div class="ml-2 mr-2 alert alert-danger">
      <i class="fas fa-exclamation-triangle"></i> Error fetching data. <a href="#" (click)="retryFetchData($event)" class="btn btn-link text-info">retry</a>    
    </div>
  </mat-card-content>
</ng-template>

<ng-template #datasetTemplate>
  <!-- datawrapper -->

  <ng-container *ngIf="dataentries | filterDataEntriesByMethods : visibleCountedDataM as filteredDataEntry">
    <mat-card-content class="h-100 w-100 overflow-hidden">
      <cdk-virtual-scroll-viewport
        class="h-100"
        itemSize="40">
        <mat-nav-list dense>
          <single-dataset-list-view
            *cdkVirtualFor="let dataset of filteredDataEntry; trackBy: trackbyFn; templateCacheSize: 0"
            (click)="showFocusedDataset(dataset)"
            [kgSchema]="(dataset.fullId | getKgSchemaIdFromFullIdPipe)[0]"
            [kgId]="(dataset.fullId | getKgSchemaIdFromFullIdPipe)[1]"
            [dataset]="dataset"
            [ripple]="true">
    
          </single-dataset-list-view>
        </mat-nav-list>
      </cdk-virtual-scroll-viewport>
    </mat-card-content>
  </ng-container>
</ng-template>

<ng-template #filePreviewTemplate>
  <preview-component
    *ngIf="filePreviewName"
    [datasetName]="filePreviewName">

  </preview-component>
</ng-template>

<ng-template #detailDataset>
  <single-dataset-view [dataset]="focusedDataset">
  </single-dataset-view>
</ng-template>

<!-- modality picker / filter -->
<ng-template #modalitySelector>
  <mat-accordion class="flex-grow-0 flex-shrink-0">

    <!-- currently selected regions -->
    <mat-expansion-panel
      [disabled]="regions.length === 0"
      #selectedRegionExpansionPanel
      hideToggle>
      <mat-expansion-panel-header>
        <mat-panel-title>
          {{ regions.length > 0 ? regions.length : 'No' }} region{{ regions.length > 1 ? 's' : '' }} selected
        </mat-panel-title>

        <mat-panel-description class="d-flex flex-row justify-content-end align-items-center">
          <i class="fas fa-brain"></i>
        </mat-panel-description>
      </mat-expansion-panel-header>

      <div class="h-10em">
        <currently-selected-regions class="h-100 d-block">
        </currently-selected-regions>
      </div>
    </mat-expansion-panel>

    <!-- Filters -->
    <mat-expansion-panel hideToggle>

      <mat-expansion-panel-header class="align-items-center">
        <mat-panel-title>
          <span *ngIf="visibleCountedDataM && visibleCountedDataM.length > 0; else defaultCount"> 
            {{ (dataentries | filterDataEntriesByMethods : visibleCountedDataM).length }} filtered datasets
          </span>
          <ng-template #defaultCount>
            {{ dataentries.length }} related datasets
          </ng-template>
        </mat-panel-title>

        <mat-panel-description class="d-flex flex-row justify-content-end align-items-center">
          <i class="fas fa-filter"></i>
        </mat-panel-description>

      </mat-expansion-panel-header>

      <ng-container *ngTemplateOutlet="modalityPicker">
      </ng-container>

    </mat-expansion-panel>
  </mat-accordion>

</ng-template>

<!-- currently unused -->
<ng-template #history>
  <mat-list>
    <mat-list-item *ngFor="let item of (history$ | async)">
      Viewed {{ item.file.name }}
    </mat-list-item>
  </mat-list>
</ng-template>